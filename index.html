<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weka Tips Admin</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Custom styles */
        .match-enter { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Token Modal -->
    <div id="tokenModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <h2 class="text-xl font-bold mb-4">GitHub Authentication</h2>
            <p class="text-gray-600 mb-4">Enter your GitHub Personal Access Token:</p>
            <input type="password" id="githubToken" placeholder="ghp_yourTokenHere" 
                   class="w-full px-4 py-2 border rounded-lg mb-4">
            <div class="flex justify-end gap-2">
                <button onclick="saveToken()" 
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                    Save Token
                </button>
            </div>
            <p id="tokenStatus" class="mt-3 text-sm"></p>
        </div>
    </div>

    <!-- Main Admin Panel -->
    <div class="container mx-auto px-4 py-8">
        <header class="bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-xl p-6 mb-8 shadow-lg">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <i class="fas fa-futbol text-3xl"></i>
                    <div>
                        <h1 class="text-2xl font-bold">Weka Tips Admin</h1>
                        <p class="text-blue-100">Manage Daily Betting Tips</p>
                    </div>
                </div>
                <button onclick="verifyData()" 
                        class="px-4 py-2 bg-white text-blue-600 rounded-lg font-medium hover:bg-gray-100 transition">
                    <i class="fas fa-sync-alt mr-2"></i> Verify Data
                </button>
            </div>
        </header>

        <!-- Status Alert -->
        <div id="uploadStatus" class="hidden mb-6 p-4 rounded-lg"></div>

        <!-- Token Status -->
        <div id="tokenStatusBar" class="hidden bg-blue-50 text-blue-800 p-3 rounded-lg mb-6 flex justify-between items-center">
            <div>
                <i class="fas fa-check-circle mr-2"></i>
                <span>Authenticated with GitHub</span>
            </div>
            <button onclick="changeToken()" class="text-blue-600 hover:text-blue-800 text-sm">
                <i class="fas fa-redo mr-1"></i> Change Token
            </button>
        </div>

        <!-- Match Forms Container -->
        <div id="matchForms" class="space-y-6"></div>

        <!-- Action Buttons -->
        <div class="fixed bottom-6 right-6 space-x-4">
            <button onclick="addMatchForm()" 
                    class="px-5 py-3 bg-green-600 text-white rounded-full shadow-lg hover:bg-green-700 transition">
                <i class="fas fa-plus"></i> Add Match
            </button>
            <button onclick="forceUpload()" 
                    class="px-5 py-3 bg-blue-600 text-white rounded-full shadow-lg hover:bg-blue-700 transition">
                <i class="fas fa-cloud-upload-alt"></i> Publish
            </button>
        </div>

        <!-- Verification Section -->
        <div id="verificationSection" class="hidden mt-12 bg-gray-50 p-6 rounded-xl border border-gray-200">
            <h3 class="text-lg font-bold mb-4">Server Data Verification</h3>
            <div class="mb-4">
                <span id="matchCountStatus" class="font-medium"></span>
                <span id="dataMatchStatus" class="ml-4"></span>
            </div>
            <pre id="serverData" class="bg-white p-4 rounded-lg overflow-auto max-h-80 text-sm"></pre>
            <div class="mt-4 flex justify-end space-x-3">
                <button onclick="verifyData()" 
                        class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition">
                    Refresh
                </button>
                <button onclick="hideVerification()" 
                        class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition">
                    Close
                </button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const REPO = 'your-username/your-repo-name';
        const FILE_PATH = 'data/tips.json';
        const BRANCH = 'main';
        
        // State
        let matchData = JSON.parse(localStorage.getItem('matchData')) || [];
        let githubToken = localStorage.getItem('githubToken') || '';
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            if (!githubToken) {
                document.getElementById('tokenModal').classList.remove('hidden');
            } else {
                initAdminPanel();
            }
            generateMatchForms();
        });
        
        // Token Functions
        function saveToken() {
            const tokenInput = document.getElementById('githubToken');
            githubToken = tokenInput.value.trim();
            
            if (!githubToken) {
                showTokenStatus('Please enter a valid token', 'red');
                return;
            }
            
            localStorage.setItem('githubToken', githubToken);
            showTokenStatus('Token saved successfully!', 'green');
            
            setTimeout(() => {
                document.getElementById('tokenModal').classList.add('hidden');
                initAdminPanel();
            }, 1000);
        }
        
        function changeToken() {
            localStorage.removeItem('githubToken');
            githubToken = '';
            document.getElementById('tokenModal').classList.remove('hidden');
            document.getElementById('tokenStatusBar').classList.add('hidden');
        }
        
        function showTokenStatus(message, color) {
            const statusEl = document.getElementById('tokenStatus');
            statusEl.textContent = message;
            statusEl.className = `mt-3 text-sm text-${color}-600`;
        }
        
        function initAdminPanel() {
            document.getElementById('tokenStatusBar').classList.remove('hidden');
        }
        
        // Match Form Functions
        function generateMatchForms() {
            const container = document.getElementById('matchForms');
            container.innerHTML = '';
            
            if (matchData.length === 0) {
                addMatchForm();
                return;
            }
            
            matchData.forEach((match, index) => {
                container.appendChild(createMatchForm(match, index));
            });
        }
        
        function createMatchForm(match, index) {
            const form = document.createElement('div');
            form.className = 'match-enter bg-white rounded-xl p-6 shadow';
            form.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold">Match ${index + 1}</h3>
                    <button onclick="removeMatch(${index})" 
                            class="text-red-500 hover:text-red-700">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">League</label>
                        <select id="league_${index}" class="w-full px-3 py-2 border rounded-lg">
                            ${getLeagueOptions(match.league)}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Time</label>
                        <input type="time" id="time_${index}" value="${match.time || '15:00'}" 
                               class="w-full px-3 py-2 border rounded-lg">
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Home Team</label>
                        <input type="text" id="homeTeam_${index}" value="${match.homeTeam || ''}" 
                               class="w-full px-3 py-2 border rounded-lg" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Away Team</label>
                        <input type="text" id="awayTeam_${index}" value="${match.awayTeam || ''}" 
                               class="w-full px-3 py-2 border rounded-lg" required>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Market</label>
                        <select id="tip_${index}" class="w-full px-3 py-2 border rounded-lg">
                            ${getTipOptions(match.tip)}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Odds</label>
                        <input type="text" id="odds_${index}" value="${match.odds || '1.75'}" 
                               class="w-full px-3 py-2 border rounded-lg" required>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Confidence</label>
                    <select id="confidence_${index}" class="w-full px-3 py-2 border rounded-lg">
                        <option value="High" ${match.confidence === 'High' ? 'selected' : ''}>High</option>
                        <option value="Medium" ${match.confidence === 'Medium' ? 'selected' : ''}>Medium</option>
                        <option value="Very High" ${match.confidence === 'Very High' ? 'selected' : ''}>Very High</option>
                    </select>
                </div>
            `;
            return form;
        }
        
        function getLeagueOptions(selected) {
            const leagues = [
                'Premier League', 'La Liga', 'Serie A', 'Bundesliga', 
                'Ligue 1', 'Champions League', 'Europa League', 'Other Leagues'
            ];
            return leagues.map(league => 
                `<option value="${league}" ${league === selected ? 'selected' : ''}>${league}</option>`
            ).join('');
        }
        
        function getTipOptions(selected) {
            const tips = [
                'Over 1.5 Goals', 'Under 1.5 Goals', 'Over 2.5 Goals', 'Under 2.5 Goals',
                'Over 3.5 Goals', 'Under 3.5 Goals', 'Home Win (1X2)', 'Draw (1X2)', 
                'Away Win (1X2)', 'BTTS - Yes', 'BTTS - No'
            ];
            return tips.map(tip => 
                `<option value="${tip}" ${tip === selected ? 'selected' : ''}>${tip}</option>`
            ).join('');
        }
        
        function addMatchForm() {
            const newMatch = {
                league: "Premier League",
                homeTeam: "",
                awayTeam: "",
                time: "15:00",
                tip: "Over 2.5 Goals",
                odds: "1.75",
                confidence: "High"
            };
            matchData.push(newMatch);
            generateMatchForms();
            scrollToBottom();
        }
        
        function removeMatch(index) {
            if (matchData.length <= 1) {
                alert("You must have at least one match!");
                return;
            }
            matchData.splice(index, 1);
            generateMatchForms();
        }
        
        function scrollToBottom() {
            window.scrollTo({
                top: document.body.scrollHeight,
                behavior: 'smooth'
            });
        }
        
        // Data Upload Functions
        async function forceUpload() {
            if (!githubToken) {
                alert("Please authenticate with GitHub first!");
                document.getElementById('tokenModal').classList.remove('hidden');
                return;
            }
            
            const statusEl = document.getElementById('uploadStatus');
            statusEl.className = 'hidden';
            
            // Collect match data
            const newMatchData = [];
            for (let i = 0; i < matchData.length; i++) {
                const league = document.getElementById(`league_${i}`)?.value;
                const homeTeam = document.getElementById(`homeTeam_${i}`)?.value;
                const awayTeam = document.getElementById(`awayTeam_${i}`)?.value;
                const time = document.getElementById(`time_${i}`)?.value;
                const tip = document.getElementById(`tip_${i}`)?.value;
                const odds = document.getElementById(`odds_${i}`)?.value;
                const confidence = document.getElementById(`confidence_${i}`)?.value;
                
                if (!homeTeam || !awayTeam) {
                    showStatus(`Please fill in all fields for Match ${i + 1}`, 'error');
                    return;
                }
                
                newMatchData.push({ league, homeTeam, awayTeam, time, tip, odds, confidence });
            }
            
            matchData = newMatchData;
            localStorage.setItem('matchData', JSON.stringify(matchData));
            
            // Prepare data for GitHub
            const tipsData = {
                matches: matchData,
                updatedAt: new Date().toISOString()
            };
            
            showStatus('Uploading to GitHub...', 'verification');
            
            try {
                // Get current file SHA
                const getFile = await fetch(`https://api.github.com/repos/${REPO}/contents/${FILE_PATH}?ref=${BRANCH}`, {
                    headers: { 
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!getFile.ok) throw new Error(`GitHub error: ${getFile.status}`);
                
                const fileInfo = await getFile.json();
                const fileSha = fileInfo.sha;
                
                // Upload new content
                const response = await fetch(`https://api.github.com/repos/${REPO}/contents/${FILE_PATH}`, {
                    method: 'PUT',
                    headers: { 
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Update tips - ${new Date().toLocaleString()}`,
                        content: btoa(unescape(encodeURIComponent(JSON.stringify(tipsData, null, 2)))),
                        sha: fileSha,
                        branch: BRANCH
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Upload failed');
                }
                
                showStatus('Successfully updated tips on GitHub!', 'success');
                setTimeout(verifyData, 1500);
                
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
                console.error('Upload error:', error);
            }
        }
        
        // Verification Functions
        async function verifyData() {
            const verificationEl = document.getElementById('verificationSection');
            const serverDataEl = document.getElementById('serverData');
            const matchCountEl = document.getElementById('matchCountStatus');
            const dataMatchEl = document.getElementById('dataMatchStatus');
            
            showStatus('Verifying server data...', 'verification');
            verificationEl.classList.remove('hidden');
            
            try {
                const response = await fetch(`https://raw.githubusercontent.com/${REPO}/${BRANCH}/${FILE_PATH}?t=${Date.now()}`);
                if (!response.ok) throw new Error('Server error: ' + response.status);
                
                const serverData = await response.json();
                serverDataEl.textContent = JSON.stringify(serverData, null, 2);
                
                // Check match count
                const serverMatchCount = serverData.matches?.length || 0;
                const localMatchCount = matchData.length;
                
                matchCountEl.innerHTML = `Server: <span class="font-bold">${serverMatchCount}</span> matches | Local: <span class="font-bold">${localMatchCount}</span> matches`;
                
                if (serverMatchCount !== localMatchCount) {
                    dataMatchEl.innerHTML = '<span class="text-red-600 font-bold">❌ Count mismatch</span>';
                } else {
                    // Deep comparison
                    const isIdentical = JSON.stringify(serverData.matches) === JSON.stringify(matchData);
                    dataMatchEl.innerHTML = isIdentical 
                        ? '<span class="text-green-600 font-bold">✅ Perfect match</span>'
                        : '<span class="text-yellow-600 font-bold">⚠️ Content differs</span>';
                }
                
            } catch (error) {
                showStatus(`Verification failed: ${error.message}`, 'error');
                serverDataEl.textContent = 'Could not load server data';
                matchCountEl.textContent = '';
                dataMatchEl.textContent = '';
            }
        }
        
        function hideVerification() {
            document.getElementById('verificationSection').classList.add('hidden');
        }
        
        // Helper Functions
        function showStatus(message, type) {
            const statusEl = document.getElementById('uploadStatus');
            statusEl.textContent = message;
            statusEl.className = `p-4 rounded-lg mb-6 ${
                type === 'success' ? 'bg-green-100 text-green-800' :
                type === 'error' ? 'bg-red-100 text-red-800' :
                'bg-yellow-100 text-yellow-800'
            }`;
            statusEl.classList.remove('hidden');
        }
    </script>
</body>
</html>