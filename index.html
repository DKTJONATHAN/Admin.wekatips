<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weka Tips - Admin Panel</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .admin-container {
            padding: 40px 0;
        }
        .upload-status {
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
            display: none;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .verification {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        #verificationSection {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            display: none;
        }
        #serverData {
            background: white;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #ddd;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
        }
        .data-mismatch {
            color: #dc3545;
            font-weight: bold;
        }
        .data-match {
            color: #28a745;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">⚽</div>
                    <div class="logo-text">
                        <h1>Weka Tips Admin</h1>
                        <p>Manage Daily Betting Tips</p>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="admin-container">
        <div class="container">
            <!-- Status Messages -->
            <div id="uploadStatus" class="upload-status"></div>
            
            <div class="section-header">
                <h2 class="section-title">Update Today's Tips</h2>
                <button onclick="verifyData()" class="btn btn-secondary" style="margin-left: auto;">Verify Server Data</button>
            </div>

            <div id="matchForms">
                <!-- Match forms will be generated here -->
            </div>

            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="add-match-btn" onclick="addMatchForm()">Add Match</button>
                <button class="save-btn" onclick="forceUpload()">Force Upload & Verify</button>
            </div>
            
            <!-- Verification Section -->
            <div id="verificationSection">
                <h3 style="margin-bottom: 15px;">Server Data Verification</h3>
                <div style="margin-bottom: 10px;">
                    <span id="matchCountStatus"></span>
                    <span id="dataMatchStatus" style="margin-left: 15px;"></span>
                </div>
                <pre id="serverData"></pre>
                <div style="margin-top: 15px;">
                    <button onclick="verifyData()" class="btn btn-secondary">Refresh Verification</button>
                    <button onclick="document.getElementById('verificationSection').style.display='none'" 
                            class="btn btn-secondary" style="margin-left: 10px;">
                        Hide Verification
                    </button>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Load matches from localStorage or use default empty array
        let matchData = JSON.parse(localStorage.getItem('matchData')) || [];

        // On page load
        document.addEventListener('DOMContentLoaded', function() {
            generateMatchForms();
        });

        function generateMatchForms() {
            const container = document.getElementById('matchForms');
            container.innerHTML = '';

            if (matchData.length === 0) {
                // Add one empty form by default
                addMatchForm();
                return;
            }

            matchData.forEach((match, index) => {
                const form = createMatchForm(match, index);
                container.appendChild(form);
            });
        }

        function createMatchForm(match, index) {
            const form = document.createElement('div');
            form.className = 'match-form';
            form.innerHTML = `
                <h3>Match ${index + 1}</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>League</label>
                        <select id="league_${index}">
                            <option value="Premier League" ${match.league === 'Premier League' ? 'selected' : ''}>Premier League</option>
                            <option value="La Liga" ${match.league === 'La Liga' ? 'selected' : ''}>La Liga</option>
                            <option value="Serie A" ${match.league === 'Serie A' ? 'selected' : ''}>Serie A</option>
                            <option value="Bundesliga" ${match.league === 'Bundesliga' ? 'selected' : ''}>Bundesliga</option>
                            <option value="Ligue 1" ${match.league === 'Ligue 1' ? 'selected' : ''}>Ligue 1</option>
                            <option value="Champions League" ${match.league === 'Champions League' ? 'selected' : ''}>Champions League</option>
                            <option value="Europa League" ${match.league === 'Europa League' ? 'selected' : ''}>Europa League</option>
                            <option value="Conference League" ${match.league === 'Conference League' ? 'selected' : ''}>Conference League</option>
                            <option value="Other Leagues" ${match.league === 'Other Leagues' ? 'selected' : ''}>Other Leagues</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Time</label>
                        <input type="time" id="time_${index}" value="${match.time || '15:00'}">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Home Team</label>
                        <input type="text" id="homeTeam_${index}" value="${match.homeTeam || ''}" required>
                    </div>
                    <div class="form-group">
                        <label>Away Team</label>
                        <input type="text" id="awayTeam_${index}" value="${match.awayTeam || ''}" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Market</label>
                        <select id="tip_${index}">
                            <option value="Over 1.5 Goals" ${match.tip === 'Over 1.5 Goals' ? 'selected' : ''}>Over 1.5 Goals</option>
                            <option value="Under 1.5 Goals" ${match.tip === 'Under 1.5 Goals' ? 'selected' : ''}>Under 1.5 Goals</option>
                            <option value="Over 2.5 Goals" ${match.tip === 'Over 2.5 Goals' ? 'selected' : ''}>Over 2.5 Goals</option>
                            <option value="Under 2.5 Goals" ${match.tip === 'Under 2.5 Goals' ? 'selected' : ''}>Under 2.5 Goals</option>
                            <option value="Over 3.5 Goals" ${match.tip === 'Over 3.5 Goals' ? 'selected' : ''}>Over 3.5 Goals</option>
                            <option value="Under 3.5 Goals" ${match.tip === 'Under 3.5 Goals' ? 'selected' : ''}>Under 3.5 Goals</option>
                            <option value="Home Win (1X2)" ${match.tip === 'Home Win (1X2)' ? 'selected' : ''}>Home Win (1X2)</option>
                            <option value="Draw (1X2)" ${match.tip === 'Draw (1X2)' ? 'selected' : ''}>Draw (1X2)</option>
                            <option value="Away Win (1X2)" ${match.tip === 'Away Win (1X2)' ? 'selected' : ''}>Away Win (1X2)</option>
                            <option value="BTTS - Yes" ${match.tip === 'BTTS - Yes' ? 'selected' : ''}>BTTS - Yes</option>
                            <option value="BTTS - No" ${match.tip === 'BTTS - No' ? 'selected' : ''}>BTTS - No</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Odds</label>
                        <input type="text" id="odds_${index}" value="${match.odds || '1.75'}" placeholder="e.g., 1.75" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Confidence</label>
                    <select id="confidence_${index}">
                        <option value="High" ${match.confidence === 'High' ? 'selected' : ''}>High</option>
                        <option value="Medium" ${match.confidence === 'Medium' ? 'selected' : ''}>Medium</option>
                        <option value="Very High" ${match.confidence === 'Very High' ? 'selected' : ''}>Very High</option>
                    </select>
                </div>
                <button type="button" onclick="removeMatch(${index})" style="background: #ef4444; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer;">Remove Match</button>
            `;
            return form;
        }

        function addMatchForm() {
            const newMatch = {
                league: "Premier League",
                homeTeam: "",
                awayTeam: "",
                time: "15:00",
                tip: "Over 2.5 Goals",
                odds: "1.75",
                confidence: "High"
            };
            matchData.push(newMatch);
            generateMatchForms();
        }

        function removeMatch(index) {
            if (matchData.length > 1) {
                matchData.splice(index, 1);
                generateMatchForms();
            } else {
                alert("You must have at least one match!");
            }
        }

        // NEW: Force upload with verification
        async function forceUpload() {
            const statusEl = document.getElementById('uploadStatus');
            statusEl.style.display = 'none';
            
            // 1. Collect all match data
            const newMatchData = [];
            for (let i = 0; i < matchData.length; i++) {
                const league = document.getElementById(`league_${i}`)?.value;
                const homeTeam = document.getElementById(`homeTeam_${i}`)?.value;
                const awayTeam = document.getElementById(`awayTeam_${i}`)?.value;
                const time = document.getElementById(`time_${i}`)?.value;
                const tip = document.getElementById(`tip_${i}`)?.value;
                const odds = document.getElementById(`odds_${i}`)?.value;
                const confidence = document.getElementById(`confidence_${i}`)?.value;

                if (league && homeTeam && awayTeam && time && tip && odds && confidence) {
                    newMatchData.push({
                        league,
                        homeTeam,
                        awayTeam,
                        time,
                        tip,
                        odds,
                        confidence
                    });
                } else {
                    showStatus(`Please fill in all fields for Match ${i + 1}`, 'error');
                    return;
                }
            }

            if (newMatchData.length === 0) {
                showStatus('No matches to upload', 'error');
                return;
            }

            matchData = newMatchData;
            localStorage.setItem('matchData', JSON.stringify(matchData));

            // 2. Prepare data for server
            const tipsData = {
                matches: matchData,
                updatedAt: new Date().toISOString()
            };

            // 3. Upload to server
            showStatus('Uploading data to server...', 'verification');
            
            try {
                const response = await fetch('https://wekatips.netlify.app/.netlify/functions/save-tips', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'x-secret': 'weka123' 
                    },
                    body: JSON.stringify(tipsData)
                });

                if (!response.ok) {
                    throw new Error(await response.text());
                }

                // 4. Verify on server
                await verifyData();
                showStatus('Data successfully uploaded and verified!', 'success');

            } catch (error) {
                showStatus(`Upload failed: ${error.message}`, 'error');
                console.error('Upload error:', error);
            }
        }

        // NEW: Verify data matches what was sent
        async function verifyData() {
            const verificationEl = document.getElementById('verificationSection');
            const serverDataEl = document.getElementById('serverData');
            const matchCountEl = document.getElementById('matchCountStatus');
            const dataMatchEl = document.getElementById('dataMatchStatus');
            
            showStatus('Verifying server data...', 'verification');
            verificationEl.style.display = 'block';

            try {
                // 1. Fetch current server data (with cache busting)
                const response = await fetch('https://wekatips.netlify.app/data/tips.json?t=' + Date.now());
                if (!response.ok) throw new Error('Server returned ' + response.status);
                
                const serverData = await response.json();
                
                // 2. Display server data
                serverDataEl.innerHTML = syntaxHighlight(serverData);
                
                // 3. Check match count
                const serverMatchCount = serverData.matches?.length || 0;
                const localMatchCount = matchData.length;
                
                matchCountEl.innerHTML = `Server matches: <b>${serverMatchCount}</b> | Local matches: <b>${localMatchCount}</b>`;
                
                if (serverMatchCount !== localMatchCount) {
                    matchCountEl.innerHTML += ' <span class="data-mismatch">(MISMATCH)</span>';
                    dataMatchEl.innerHTML = '<span class="data-mismatch">❌ Data mismatch detected</span>';
                } else {
                    matchCountEl.innerHTML += ' <span class="data-match">(MATCHING)</span>';
                    
                    // 4. Deep comparison (optional)
                    const isDataIdentical = JSON.stringify(serverData.matches) === JSON.stringify(matchData);
                    if (isDataIdentical) {
                        dataMatchEl.innerHTML = '<span class="data-match">✅ Data matches perfectly</span>';
                    } else {
                        dataMatchEl.innerHTML = '<span class="data-mismatch">⚠️ Count matches but content differs</span>';
                    }
                }
                
            } catch (error) {
                showStatus(`Verification failed: ${error.message}`, 'error');
                serverDataEl.textContent = 'Could not load server data';
                matchCountEl.textContent = '';
                dataMatchEl.textContent = '';
                console.error('Verification error:', error);
            }
        }

        // Helper functions
        function showStatus(message, type) {
            const statusEl = document.getElementById('uploadStatus');
            statusEl.textContent = message;
            statusEl.className = `upload-status ${type}`;
            statusEl.style.display = 'block';
        }

        function syntaxHighlight(json) {
            if (typeof json === 'string') {
                try {
                    json = JSON.parse(json);
                } catch (e) {
                    return json; // Return as-is if not JSON
                }
            }
            
            const jsonStr = JSON.stringify(json, null, 2);
            return jsonStr
                .replace(/("[\w]+":)/g, '<span style="color:blue">$1</span>')
                .replace(/(true|false|null)/g, '<span style="color:green">$1</span>')
                .replace(/(\d+\.\d+)/g, '<span style="color:purple">$1</span>');
        }
    </script>
</body>
</html>